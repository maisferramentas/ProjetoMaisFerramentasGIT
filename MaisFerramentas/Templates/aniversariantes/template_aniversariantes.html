<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f0f0f0;
        margin: 0;
        padding: 0;
    }

    .div_lista_de_aniversariantes p {
        color: #555;
        margin: 0;
    }
    .div_lista_de_aniversariantes {
        display:flex;
        max-width: 400px;
        flex-direction: column;
        justify-content: center;
        
    }
    .card{
        display: flex;
        margin-bottom: 10px;
        align-items: center;
        max-width: 340px;
    }
    .card_padrao{
        display: flex;
        margin-bottom: 10px;
        display: none;
    }
    .informacao_complementar_do_card{
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .limite_box{
        max-width: 300px;
    }

    .opcoes{
        margin-left: auto;
    }
</style>
</head>
<body>
    <div class="conteudo" id="conteudo">
        <h1>Aniversariantes</h1>
        <div class="filtros">
            <label for="data_inicio">Data Início: </label>
            <input type="date" name="" id="data_inicio">
        </div>

        <label for="data_fim">Data Final: </label>
        <input type="date" name="" id="data_fim">

        <!-- INICIO card padrão para clonar e replicar -->
        <div class="div_lista_de_aniversariantes" >
            <div class="card_padrao">
                <svg xmlns="http://www.w3.org/2000/svg" height="48px" viewBox="0 -960 960 960" width="48px" fill="#5f6368"><path d="M480-242q-67 0-129 23.5T235-149v9h490v-9q-54-46-116-69.5T480-242Zm0-60q74 0 139.5 24.5T740-211v-609H220v609q55-42 120.5-66.5T480-302Zm2-139q-32.5 0-55.25-22.75T404-519q0-32.5 22.75-55.25T482-597q32.5 0 55.25 22.75T560-519q0 32.5-22.75 55.25T482-441ZM220-80q-24 0-42-18t-18-42v-680q0-24 18-42t42-18h520q24 0 42 18t18 42v680q0 24-18 42t-42 18H220Zm262-301q58 0 98-40t40-98q0-58-40-98t-98-40q-58 0-98 40t-40 98q0 58 40 98t98 40Zm-2-138Z"/></svg>
                <div class="informacao_complementar_do_card" >
                    <p id="nome" class="limite_box" >Nome Exemplo</p> 
                    <p id="data_idade_organizacao" class="limite_box">Campo Exemplo: 12/04/1930 (94 anos) S. Socorro </p> 
                    <p id="nova_idade_e_dia_da_semana" class="limite_box">40 anos quinta-feira </p> 
                </div>
                <span class="material-symbols-outlined opcoes">
                    more_vert
                </span>
            </div>
        </div>
        <!-- FIM card padrão para clonar e replicar -->

    </div>
</body>
<script>
    //Obtem do banco todas os aniversariantes
    obter_dados_aniversariantes();
    function obter_dados_aniversariantes(){
        var url = '/obter_dados_aniversariantes';
        var sucesso = preparar_dados;
        
        $.ajax({
            url:url,
            success: function(result){
                sucesso(result);
            },
            error: function(result){console.log(result)},
        });
    }

    //Captura o campo de tada
    var data_inicio = $('#data_inicio');

    //Declara data atual
    var hoje = new Date();

    // Ajusta o fuso horário para GMT-03:00 (180 minutos antes de UTC)
    hoje.setMinutes(hoje.getMinutes() -180);

    //Formata para dar valor ao campo de data
    var hojeFormatado = hoje.toISOString().split('T')[0];

    //Atribui valor ao campo de data
    data_inicio.val(hojeFormatado);

    //Atribui uma função para a alteração do campo
    data_inicio.on('change', filtrar_dados_aniversariantes);

    //Captura o campo de tada
    var data_fim = $('#data_fim');
    
    // Define a data para o último dia do mês corrente
    var ultimoDiaMesCorrente = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);

    // Formata a data para o último dia do mês corrente
    var ultimoDiaMesCorrenteFormatado = ultimoDiaMesCorrente.toISOString().split('T')[0];

    //Atribui valor ao campo de data
    data_fim.val(ultimoDiaMesCorrenteFormatado);

    //Atribui uma função para a alteração do campo
    data_fim.on('change', filtrar_dados_aniversariantes);

    // Declara data para amanhã
    var amanha = new Date(hoje);
    amanha.setDate(amanha.getDate() + 1);

    // Formata para dar valor ao campo de data
    var amanhaFormatado = amanha.toISOString().split('T')[0];

    function preparar_dados(result){
        dados_aniversariantes = result.dados_aniversariantes;
        filtrar_dados_aniversariantes();
    }

    function filtrar_dados_aniversariantes(){
        capturar_filtros();

        dados_aniversariantes_fltrados = dados_aniversariantes.filter((element) => 
            //Filtro de Data (Dia)
            parseInt(element.dia_aniversario) >= parseInt(value_data_inicio.substr(8,2))
            && parseInt(element.dia_aniversario) <= parseInt(value_data_fim.substr(8,2))
            //Filtro de Data (Mês)
            && parseInt(element.mes_aniversario) >= parseInt(value_data_inicio.substr(5,2))
            && parseInt(element.mes_aniversario) <= parseInt(value_data_fim.substr(5,2))
        );

        exibir_na_tela(dados_aniversariantes_fltrados)
    }

    function capturar_filtros(){
        value_data_inicio = data_inicio.val();
        value_data_fim = data_fim.val();
    }
    
    const copia_card_padrao = $('.div_lista_de_aniversariantes').clone();
    function exibir_na_tela(dados) {
        console.log(dados);

        var div_lista_de_aniversariantes = $('.div_lista_de_aniversariantes');

        div_lista_de_aniversariantes.html('');

        dados.forEach(function(element) {
            //Linha do Nome
            copia_card_padrao.find('#nome').text(element.nome_interno);

            //Lina da Idade e organização
            //Monta o formato "20/5/1977 (47 anos) Q. Elderes"
            var data_idade_organizacao = 
                formatar_data(element.data_aniversário) + ' (' +
                element.idade + ' anos) ' +
                element.organizacao;

            copia_card_padrao.find('#data_idade_organizacao').text(data_idade_organizacao);
            
            //Linha da nova idade e dia da semana do aniversario
            //Define a nova idade
            if(dia <= hoje.getDate() && mes <= hoje.getMonth() + 1){
                nova_idade = parseInt(element.idade); 
            }else{
                nova_idade = parseInt(element.idade)+1;
            }

            //Monta o formato "Faz: 40 anos quinta-feira" 
            var nova_idade_e_dia_da_semana = nova_idade + ' anos ' + nome_do_dia_da_semana;

            copia_card_padrao.find('#nova_idade_e_dia_da_semana').text(nova_idade_e_dia_da_semana);

            //Ajusta a classe para exibir o card
            copia_card_padrao.find('.card_padrao').addClass('card');
            copia_card_padrao.find('.card_padrao').removeClass('card_padrao');

            //Ajusta o Id
            copia_card_padrao.find('.card')[0].id  = element.id_membro_interno;

            //Insere o card na tela
            div_lista_de_aniversariantes.append(copia_card_padrao.html());
        });
    }

    function formatar_data(element){
        dia = parseInt(element.substr(8,2));

        mes = parseInt(element.substr(5,2));

        ano = parseInt(element.substr(0,4));

        data_aniversario = new Date(hoje.getFullYear(),mes-1,dia);
        
        nome_do_dia_da_semana = obter_nome_do_dia_da_semana(data_aniversario.getDay());

        data_formatada = dia+'/'+mes+'/'+ano;
        return data_formatada;
    }

    function obter_nome_do_dia_da_semana(numero_do_dia_da_semana){
        var diasSemana = [
          "Domingo",
          "Segunda-feira",
          "Terça-feira",
          "Quarta-feira",
          "Quinta-feira",
          "Sexta-feira",
          "Sábado",
        ];

        nome_do_dia_da_semana = diasSemana[numero_do_dia_da_semana];
        
        return nome_do_dia_da_semana;
    }

</script>
</html>